"use strict";!function(e,t,n){function s(){var s={createEle:function(e,n){var s=t.createElement(e);for(var i in n)n.hasOwnProperty(i)&&(s[i]=n[i]);return s},extends:function(e,t){var n=arguments;if(n.length>2)return this.extends.apply(this,this.slice.call(n,1));for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s]);return e},slice:[].slice,getAgent:function(){var e=/mobile/i;return{isMobile:e.test(navigator.userAgent)}},calcDistance:function(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))},addEvent:function(e,n,i,o){var r=this;if(n=c.isMobile?{click:"touchend"}[n]||n:n,!e)throw new Error("未找到需绑定事件的元素");3===arguments.length&&(o=i),"string"==typeof e&&(e=s.slice.call(t.querySelectorAll(e),0)),e=[].concat(e),arguments.length>3?e.forEach(function(e){e.addEventListener(n,function(){var t=event.srcElement,n=r.slice.call(e.querySelectorAll(i),0),s=n.indexOf(t);s>-1&&o.call(n[s],s,n)})}):e.forEach(function(e){e.addEventListener(n,o)})}},i={currentIndex:0,lastIndex:0,currentImg:n,imgs:[],setImgs:function(e){this.imgs=e},setImg:function(e){var t=this.imgs.length-1;e<0&&(e=t),e>t&&(e=0),this.lastIndex=this.currentImg,this.currentImg=this.imgs[e],this.currentIndex=e}},o={init:function(){var e=c.isMobile=s.getAgent().isMobile,n=t.getElementById("crab_popup_style")||s.createEle("style",{id:"crab_popup_style",innerText:""}),i=e?'<div id="crab_popup_pane"><div class="img_box"></div></div><span class="crab_popup_close"></span>':'<span class="prev change"></span><div id="crab_popup_pane"><div class="img_box"></div><div class="page_num"></div></div><span class="crab_popup_close"></span><span class="next change"></span>',o=this.box=t.getElementById("crab_popup_box")||s.createEle("div",{id:"crab_popup_box",className:e?"mobile":"pc",innerHTML:i});t.head.appendChild(n),t.body.appendChild(o)},currentImg:n,setImg:function(){var n=i.imgs[i.currentIndex],o=t.getElementById("crab_popup_box"),r=t.getElementById("crab_popup_pane"),a=r.querySelector(".img_box"),l=r.querySelector(".page_num"),u=s.createEle("img",{onload:function(){var n=event.target,s=e.getComputedStyle(n),i=parseInt(s.width),o=parseInt(s.height),r=i/o,a=t.body.scrollWidth,l=t.body.scrollHeight,u=a/l;c.isMobile&&(i>=o||r>u?n.style.width=a+"px":n.style.height=l+"px")},src:n.src});a.innerHTML="",a.appendChild(u),this.currentImg=u,c.isMobile||(l.innerText=i.currentIndex+1+" / "+i.imgs.length),o.style.display="block",o.classList.add("show")},close:function(){var e=this.box;e.classList.remove("show"),setTimeout(function(){e.style.display="none"},250)}},c={root:[],defaults:{selector:"img",maskClosable:!0},touch:{count:0},init:function(e,n){if(!e)throw new Error("未传入DOM节点");1!==e.nodeType&&(e=s.slice.call(t.querySelectorAll(e),0)),this.root=[].concat(e),this.opts=s.extends({},this.defaults,n),o.init(),this.bindEvent()},bindEvent:function(){var n=this,r=t.getElementById("crab_popup_box"),a=r.querySelector(".crab_popup_close");if(this.root.forEach(function(e){s.addEvent(e,"click",n.opts.selector,function(t,s){if(i.imgs.indexOf(s[t])>-1)console.time("noMatch"),n.setImg(t),console.timeEnd("noMatch");else{console.time("match");for(var o=[].slice.call(e.querySelectorAll(n.opts.contextSelector),0),c=s[t],r=o.length-1;r>=0;r--){var a=[].slice.call(o[r].querySelectorAll(n.opts.selector),0);if(a.indexOf(c)>-1){n.setImg(t,a);break}}console.timeEnd("match")}}.bind(e))}),this.isMobile){var l=r.querySelector("#crab_popup_pane");l.querySelector("img");s.addEvent(l,"touchstart","img",function(){var e=event.touches[0],t=n.touch;o.currentImg.style.transformOrigin=e.clientX+"px "+(e.clientY+10)+"px",t.y=e.clientY}),s.addEvent(l,"touchstart",function(){var e=event.touches[0],t=n.touch;t.start=!0,t.x=e.clientX}),s.addEvent(l,"touchmove","img",function(){var t=event.touches[0].clientY,s=n.touch.y,i=Math.abs(t-s),c=Math.sqrt(e.screen.height/2);Math.abs(i)>30&&(n.touch.start=!1,o.currentImg.style.transform="scale("+2*Math.sqrt(i)/c+")")}),s.addEvent(l,"touchend",function(){var e=n.touch,t=event.changedTouches[0],s=t.clientX,i=s-e.x,r=i>0?1:-1,a={"-1":c.next.bind(c),1:c.prev.bind(c)}[r];e.start?(Math.abs(i)>=50&&a(),e.start=!1):o.currentImg.style.transform="scale(1)"})}else!function(){var e=r.querySelector(".prev"),t=r.querySelector(".next");s.addEvent(e,"mouseover",function(){e.classList.add("show"),t.classList.add("show")}),s.addEvent(t,"mouseover",function(){e.classList.add("show"),t.classList.add("show")}),s.addEvent(e,"mouseleave",function(){e.classList.remove("show"),t.classList.remove("show")}),s.addEvent(t,"mouseleave",function(){e.classList.remove("show"),t.classList.remove("show")}),s.addEvent(e,"click",function(){event.stopPropagation(),n.prev()}),s.addEvent(t,"click",function(){event.stopPropagation(),n.next()}),n.opts.maskClosable&&r.addEventListener("click",function(){o.close()})}();s.addEvent(a,"click",function(){event.stopPropagation(),o.close()})},setImg:function(e){var t=arguments.length<=1||arguments[1]===n?i.imgs:arguments[1];i.setImgs(t),i.setImg(e),o.setImg()},prev:function(){this.isMobile&&(o.currentImg.style.transform="translateX(100%)"),i.setImg(--i.currentIndex),setTimeout(o.setImg.bind(o,!0),250),o.setImg()},next:function(){this.isMobile&&(o.currentImg.style.transform="translateX(-100%)"),i.setImg(++i.currentIndex),o.setImg()}};this.init=c.init.bind(c)}e.Popup=new s}(window,window.document);